#!/bin/bash

# Configuration
OLLAMA_URL=$(git config --global --get ollama.url || echo "http://localhost:11434")
MODEL=$(git config --global --get ollama.model || echo "mistral")
COMMIT_MSG_FILE=$1
MAX_DIFF_LENGTH=3000
#

ORIGINAL_MSG=$(cat "$COMMIT_MSG_FILE")
if [ -z "$ORIGINAL_MSG" ]; then
    exit 0
fi

DIFF=$(git diff --cached -- . ':(exclude)package-lock.json' ':(exclude)yarn.lock' ':(exclude)*.lock')
if [ -z "$DIFF" ]; then
    exit 0
fi

if [ ${#DIFF} -gt $MAX_DIFF_LENGTH ]; then
    echo "‚ö†Ô∏è  Diff trop long, tronqu√© aux $MAX_DIFF_LENGTH premiers caract√®res pour Ollama."
    DIFF="${DIFF:0:$MAX_DIFF_LENGTH}\n...(diff truncated)"
fi

echo "ü§ñ Analyse du code et r√©√©criture du commit avec $MODEL..."

SYSTEM_PROMPT="You are a senior developer assistant.
Your goal is to rewrite the git commit message based on the provided code changes (diff) and the user's initial draft.
Rules:
1. Use the 'Conventional Commits' format (type(scope): description).
2. The user's draft gives the INTENT. The diff gives the DETAILS. Combine them.
3. Keep the subject line under 72 chars.
4. Output ONLY the final commit message. No quotes, no chatter."

PAYLOAD=$(jq -n \
          --arg model "$MODEL" \
          --arg system "$SYSTEM_PROMPT" \
          --arg msg "$ORIGINAL_MSG" \
          --arg diff "$DIFF" \
          '{
            model: $model,
            stream: false,
            prompt: ($system + "\n\nUSER DRAFT: " + $msg + "\n\nCODE CHANGES:\n" + $diff)
           }')

RESPONSE=$(curl -s -X POST "$OLLAMA_URL/api/generate" \
    -H "Content-Type: application/json" \
    -d "$PAYLOAD")

NEW_MSG=$(echo "$RESPONSE" | jq -r '.response' | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
if [ -n "$NEW_MSG" ] && [ "$NEW_MSG" != "null" ]; then
    echo "$NEW_MSG" > "$COMMIT_MSG_FILE"
    echo -e "\033[0;32m‚úî Commit transform√© :\033[0m"
    echo "  $NEW_MSG"
else
    echo -e "\033[0;31m‚úò Erreur Ollama (ou r√©ponse vide). Message original conserv√©.\033[0m"
fi