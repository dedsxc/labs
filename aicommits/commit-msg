#!/bin/bash

# Configuration
OLLAMA_URL=$(git config --global --get ollama.url || echo "http://localhost:11434")
MODEL=$(git config --global --get ollama.model || echo "mistral")
COMMIT_MSG_FILE=$1
MAX_DIFF_LENGTH=3000
#

ORIGINAL_MSG=$(cat "$COMMIT_MSG_FILE")
if [ -z "$ORIGINAL_MSG" ]; then
    exit 0
fi

DIFF=$(git diff --cached -- . ':(exclude)package-lock.json' ':(exclude)yarn.lock' ':(exclude)*.lock')
if [ -z "$DIFF" ]; then
    exit 0
fi

if [ ${#DIFF} -gt $MAX_DIFF_LENGTH ]; then
    echo "‚ö†Ô∏è  Diff trop long, tronqu√© aux $MAX_DIFF_LENGTH premiers caract√®res pour Ollama."
    DIFF="${DIFF:0:$MAX_DIFF_LENGTH}\n...(diff truncated)"
fi

echo "ü§ñ Analyse du code et r√©√©criture du commit avec $MODEL..."

read -r -d '' SYSTEM_PROMPT << 'EOF'
You are a **Senior Developer Assistant** specialized in Git history cleanliness and best practices.

Your goal is to rewrite the git commit message based on the provided code changes (diff) and the user's initial draft.

<rules>
1. **Format:** STRICTLY use the 'Conventional Commits' format: `type(scope): description`.
   - Allowed types: `feat`, `fix`, `docs`, `style`, `refactor`, `perf`, `test`, `build`, `ci`, `chore`, `revert`.
2. **Synthesis Logic:**
   - The user's draft provides the **INTENT**.
   - The code diff provides the **DETAILS**.
   - You must combine them to create a factual and meaningful message.
3. **Length Constraints:** The subject line must be **under 72 characters**.
4. **Output Format:**
   - Output **ONLY** the final commit message.
   - NO markdown code blocks (no ```).
   - NO quotes.
   - NO conversational filler (e.g., "Here is your message").
</rules>

<workflow>
1. Analyze the currently active changes (diff) to understand technically *what* happened.
2. Read the user's input to understand *why* it happened.
3. Formulate the message using the format `type(scope): description`.
4. If necessary for complex changes, add a body separated by a blank line.
5. Return the raw text string.
</workflow>
EOF

PAYLOAD=$(jq -n \
          --arg model "$MODEL" \
          --arg system "$SYSTEM_PROMPT" \
          --arg msg "$ORIGINAL_MSG" \
          --arg diff "$DIFF" \
          '{
            model: $model,
            stream: false,
            prompt: ($system + "\n\nUSER DRAFT: " + $msg + "\n\nCODE CHANGES:\n" + $diff)
           }')

RESPONSE=$(curl -s -X POST "$OLLAMA_URL/api/generate" \
    -H "Content-Type: application/json" \
    -d "$PAYLOAD")

NEW_MSG=$(echo "$RESPONSE" | jq -r '.response' | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
if [ -n "$NEW_MSG" ] && [ "$NEW_MSG" != "null" ]; then
    echo "$NEW_MSG" > "$COMMIT_MSG_FILE"
    echo -e "\033[0;32m‚úî Commit transform√© :\033[0m"
    echo "  $NEW_MSG"
else
    echo -e "\033[0;31m‚úò Erreur Ollama (ou r√©ponse vide). Message original conserv√©.\033[0m"
fi